<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App Management</title>
    <link rel="stylesheet" href="fontawesome/webfonts/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="/eel.js"></script>
    <style>
        body { display: flex; overflow: hidden; height: 100vh; font-family: 'Segoe UI', sans-serif; margin: 0; color: white; background-color: #1a1a1a; }
        .sidebar { width: 250px; height: 100%; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; padding: 20px; transition: width 0.3s ease; flex-shrink: 0; z-index: 20; position: relative; }
        .sidebar.collapsed { width: 70px; padding: 20px 10px; } 
        .sidebar.collapsed #tagList {margin-top: 20px;}
        .sidebar.collapsed .nav-content{justify-content: center;}
        .sidebar.collapsed h2, .sidebar.collapsed .nav-text, .sidebar.collapsed .add-tag-text, .sidebar.collapsed .edit-tag-btn { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; }
        .sidebar.collapsed .nav-item i { margin-right: 0; font-size: 1.4rem; }
        .toggle-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .sidebar.collapsed .toggle-btn { right: 50%; transform: translateX(50%); }
        .sidebar h2 { margin-top: 40px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .nav-item { color: rgba(255,255,255,0.7); padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nav-content { display: flex; align-items: center; width: 100%; }
        .nav-item i { width: 30px; text-align: center; margin-right: 10px; }
        .add-tag-btn {  background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.3); color: #ccc; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .main-content { flex: 1; position: relative; height: 100%; overflow: hidden; }
        .view-section { display: none; height: 100%; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }
        .glass-container { width: 100%; height: 100%; padding: 30px; box-sizing: border-box; overflow-y: auto; }
        .dashboard-header { display: flex; align-items: center; margin-bottom: 25px; gap: 15px; }
        .title { font-size: 2rem; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin-right: auto; }
        .search-box { position: relative; }
        .search-box input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px 35px 8px 15px; border-radius: 20px; color: white; outline: none; width: 200px; transition: 0.3s; backdrop-filter: blur(5px); }
        .search-box input:focus { background: rgba(255,255,255,0.2); width: 250px; border-color: rgba(255,255,255,0.5); }
        .search-box i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); pointer-events: none; z-index: 20;}
        .btn-bg { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 1.2rem; width: 40px; height: 40px; border-radius: 50%; transition:0.3s; display: flex; align-items: center; justify-content: center; }
        .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 20px; padding: 10px; }
        .app-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; border: 1px solid rgba(255,255,255,0.05); height: 130px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .app-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.2); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .app-icon-font { font-size: 3rem; color: #fff; }
        .app-icon-img { width: 56px; height: 56px; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
        .app-card span { margin-top:10px; font-size: 0.9rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2; }
        .card-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: 0.2s; pointer-events: none; }
        .app-card:hover .card-actions { opacity: 1; pointer-events: auto; }
        .action-btn { width: 26px; height: 26px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .btn-edit { background: #f39c12; } .btn-delete { background: #e74c3c; }
        .editor-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .editor-modal { background: #222; padding: 25px; border-radius: 15px; width: 420px; color: white; box-shadow: 0 0 30px rgba(0,0,0,0.7); border: 1px solid #444; max-height: 90vh; overflow-y: auto;z-index: 99; }
        .editor-modal h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        .form-control { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { flex: 1; padding: 12px; background: #4facfe; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .btn-cancel { flex: 1; padding: 12px; background: #444; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .radio-group { display: flex; flex-direction: column; gap: 8px; background: #333; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .radio-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95rem; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #4facfe; color: white; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; z-index: 50; display:flex; align-items:center; justify-content:center; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        .select-file-btn { border: 2px dashed #555; background: rgba(255,255,255,0.05); color: #ddd; padding: 20px; border-radius: 8px; width: 100%; cursor: pointer; text-align: center; font-size: 1rem; transition: 0.3s; }
        .select-file-btn:hover { border-color: #4facfe; background: rgba(255,255,255,0.1); color: white; }
        .browser-list-item { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #444; }
        .browser-list-item:hover { background: #3a3a3a; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <video id="bgVideo" autoplay muted loop class="bg-video" style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;"></video>

    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <h2>My Launcher</h2>
        <div id="tagList"></div>
        <button class="add-tag-btn" onclick="openTagModal('create')">
            <i class="fa-solid fa-plus"></i> <span class="add-tag-text">New Tag</span>
        </button>
    </div>

    <div class="main-content">
        <div id="viewsContainer"></div>
    </div>

    <button id="mainFab" class="fab" onclick="handleFabClick()">+</button>

    <div id="browserManagerModal" class="editor-overlay" style="z-index: 109;">
        <div class="editor-modal" style="z-index: 110;">
            <h3>Manage Browsers</h3>
            <label style="color:#aaa; font-size:0.9rem;">Existing Browsers:</label>
            <div style="max-height: 150px; overflow-y: auto; margin-bottom: 20px; background:#111; padding:5px; border-radius:8px;" id="browserManagerList"></div>
            <div style="border-top: 1px solid #444; padding-top: 15px;">
                <label style="color:#aaa; font-size:0.9rem;">Add New Browser:</label>
                <input type="text" id="newBrowserName" class="form-control" placeholder="Browser Name (e.g. OperaGX)" style="margin-bottom: 8px;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom: 8px;">
                    <input type="text" id="newBrowserPath" class="form-control" placeholder="Path to .exe" style="margin-bottom: 0; flex:1;">
                    <button onclick="pickExePath('newBrowserPath')" style="background:#444; border:1px solid #555; color:white; width:40px; height:38px; border-radius:8px; cursor:pointer;" title="Select File">
                        <i class="fa-solid fa-folder-open"></i>
                    </button>
                </div>
                
                <button class="btn-save" onclick="addNewBrowser()" style="width:100%;"><i class="fa-solid fa-plus"></i> Add to List</button>
            </div>
            <div class="btn-row"><button class="btn-cancel" onclick="document.getElementById('browserManagerModal').style.display='none'">Close</button></div>
        </div>
    </div>

    <div id="browserEditor" class="editor-overlay">
        <div class="editor-modal">
            <h3>Manage Browser Group</h3>
            <input type="text" id="b_groupName" class="form-control" placeholder="Group Name (e.g. Work)">
            
            <label style="color:#aaa; font-size:0.9rem;">Select Browser:</label>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                <select id="b_browserSelect" class="form-control" onchange="handleBrowserSelect()" style="margin-bottom:0; flex:1;"></select>
                <button onclick="openBrowserManager()" title="Add/Remove Browsers" style="background:#444; color:white; border:1px solid #555; width:45px; height:42px; border-radius:8px; cursor:pointer; font-size:1.1rem;"><i class="fa-solid fa-gear"></i></button>
            </div>

            <div id="b_profileDiv">
                <label style="color:#aaa; font-size:0.9rem;">Profile:</label>
                <select id="b_profileSelect" class="form-control"><option value="Default">Default</option></select>
            </div>

            <label style="color:#aaa; font-size:0.9rem;">URLs:</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="b_urlInput" class="form-control" placeholder="https://..." style="margin-bottom:0">
                <button onclick="addUrlItem()" style="width:50px; background:#555; color:white; border:none; border-radius:8px; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="b_urlList" style="max-height:80px; overflow-y:auto; background:#333; padding:10px; border-radius:8px; list-style:none; margin-bottom:15px; border:1px solid #444;"></ul>
            
            <label style="color:#aaa; font-size:0.9rem; margin-top:15px; display:block;">Run these apps with browser:</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="b_startupAppInput" class="form-control" placeholder="Path to .exe" style="margin-bottom:0; flex:1;">
                <button onclick="pickExePath('b_startupAppInput')" style="width:40px; background:#444; color:white; border:1px solid #555; border-radius:8px; cursor:pointer;"><i class="fa-solid fa-folder-open"></i></button>
                <button onclick="addStartupAppItem()" style="width:50px; background:#555; color:white; border:none; border-radius:8px; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="b_startupAppList" style="max-height:80px; overflow-y:auto; background:#333; padding:10px; border-radius:8px; list-style:none; margin-bottom:15px; border:1px solid #444;"></ul>

            <label style="color:#aaa; font-size:0.9rem;">Icon Style:</label>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="b_iconType" value="default" checked onchange="toggleBIconInput()"> <i class="fa-brands fa-windows"></i> Browser Default</label>
                <label class="radio-label"><input type="radio" name="b_iconType" value="font" onchange="toggleBIconInput()"> <i class="fa-solid fa-icons"></i> FontAwesome</label>
                <label class="radio-label"><input type="radio" name="b_iconType" value="image" onchange="toggleBIconInput()"> <i class="fa-solid fa-image"></i> Custom Image</label>
            </div>
            <div id="b_iconFontGroup" style="display:none;"><input type="text" id="b_appIconInput" class="form-control" placeholder="fa-solid fa-globe"></div>
            <div id="b_iconImageGroup" style="display:none; margin-bottom:15px;"><div class="upload-btn-wrapper"><button class="btn-save" style="background:#555;">Choose Image...</button><input type="file" id="b_appImgFile" accept="image/*"></div></div>
            <div class="btn-row"><button class="btn-cancel" onclick="document.getElementById('browserEditor').style.display='none'">Cancel</button><button class="btn-save" onclick="saveBrowserGroup()">Save</button></div>
        </div>
    </div>

    <div id="settingsModal" class="editor-overlay">
        <div class="editor-modal">
            <h3>Background Settings</h3>
            <label class="radio-label" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:20px;">
                <input type="checkbox" id="bgApplyAll"> Apply to ALL Tags
            </label>
            <div style="display:grid; gap:15px;">
                <button class="select-file-btn" onclick="selectBgFromPython('video')"><i class="fa-solid fa-video"></i> Select Video</button>
                <button class="select-file-btn" onclick="selectBgFromPython('image')"><i class="fa-solid fa-image"></i> Select Image</button>
            </div>
            <div style="text-align:center; margin-top:10px; color:#aaa; font-size:0.9rem;" id="bgPreviewStatus">No file selected</div>
            <div class="btn-row"><button class="btn-cancel" onclick="closeSettings()">Cancel</button><button class="btn-save" onclick="saveSettings()">Save Settings</button></div>
        </div>
    </div>

    <div id="appModal" class="editor-overlay">
        <div class="editor-modal">
            <h3 id="appModalTitle">Add Application</h3>
            <input type="hidden" id="editAppIndex">
            <input type="text" id="appNameInput" class="form-control" placeholder="App Name">
            
            <div style="display:flex; gap:10px; align-items:center; margin-bottom: 15px;">
                <input type="text" id="appPathInput" class="form-control" placeholder="Path to .exe" style="margin-bottom: 0; flex:1;">
                <button onclick="pickExePath('appPathInput')" style="background:#444; border:1px solid #555; color:white; width:40px; height:38px; border-radius:8px; cursor:pointer;" title="Select File">
                    <i class="fa-solid fa-folder-open"></i>
                </button>
            </div>

            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="iconType" value="default" checked onchange="toggleIconInput()"> <i class="fa-brands fa-windows"></i> Default (.exe)</label>
                <label class="radio-label"><input type="radio" name="iconType" value="font" onchange="toggleIconInput()"> <i class="fa-solid fa-icons"></i> FontAwesome</label>
                <label class="radio-label"><input type="radio" name="iconType" value="image" onchange="toggleIconInput()"> <i class="fa-solid fa-image"></i> Image</label>
            </div>
            <div id="iconFontGroup" style="display:none;"><input type="text" id="appIconInput" class="form-control" placeholder="fa-solid fa-gamepad"></div>
            <div id="iconImageGroup" style="display:none; margin-bottom:15px;"><div class="upload-btn-wrapper"><button class="btn-save" style="background:#555;">Choose Image...</button><input type="file" id="appImgFile" accept="image/*"></div></div>
            <div class="btn-row"><button class="btn-cancel" onclick="document.getElementById('appModal').style.display='none'">Cancel</button><button class="btn-save" onclick="saveAppItem()">Save</button></div>
        </div>
    </div>

    <div id="tagModal" class="editor-overlay">
            <div class="editor-modal">
                <h3>Manage Tag</h3>
                <input type="hidden" id="tagIdEdit">
                <input type="text" id="tagNameInput" class="form-control" placeholder="Tag Name">
                <input type="text" id="tagIconInput" class="form-control" placeholder="fa-solid fa-folder">
                
                <label class="radio-label" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px;display: none;">
                    <input type="checkbox" id="tagDevModeInput"> Enable Dev Mode
                </label>
                
                <div class="btn-row">
                    <button class="btn-save" onclick="saveTag()">Save</button>
                    <button id="btnDeleteTag" class="btn-cancel" style="background:#e74c3c; display:none;" onclick="deleteTag()">Delete</button>
                    <button class="btn-cancel" onclick="document.getElementById('tagModal').style.display='none'">Cancel</button>
                    
                </div>
            </div>
        </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let appData = { globalBg: "", globalBgType: "", tags: [], apps: [], browsers: [] };
        let currentTagId = null;
        let tempBgData = null;
        let browserGroups = {}; 
        let b_urls = [];
        let b_startupApps = []; // NEW: Store startup apps

        // --- INIT ---
        window.addEventListener('load', async () => {
            const data = await eel.load_data()();
            if(data) appData = data;
            
            if(!appData.tags || appData.tags.length === 0) appData.tags = [ { id: "browser", name: "Browser", icon: "fa-globe", type: "system" } ];
            if(!appData.browsers || appData.browsers.length === 0) {
                appData.browsers = [
                    { name: "Google Chrome", path: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe", type: "Chrome" },
                    { name: "Microsoft Edge", path: "C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe", type: "Edge" },
                    { name: "Brave Browser", path: "C:\\Program Files\\BraveSoftware\\Brave-Browser\\Application\\brave.exe", type: "Brave" }
                ];
            }

            browserGroups = await eel.get_saved_groups()();
            renderSidebar();
            if(appData.tags.length > 0) switchTab(appData.tags[0].id);
        });

        // --- BROWSER MANAGER ---
        function openBrowserManager() {
            document.getElementById('browserManagerModal').style.display = 'flex';
            renderBrowserManagerList();
            document.getElementById('newBrowserName').value = '';
            document.getElementById('newBrowserPath').value = '';
        }
        function renderBrowserManagerList() {
            const list = document.getElementById('browserManagerList'); list.innerHTML = '';
            appData.browsers.forEach((b, i) => {
                list.innerHTML += `<div class="browser-list-item"><div><strong style="color:#4facfe;">${b.name}</strong><div style="font-size:0.75rem;color:#aaa;" title="${b.path}">${b.path}</div></div><button onclick="removeBrowser(${i})" style="background:#e74c3c;color:white;border:none;border-radius:5px;width:30px;height:30px;cursor:pointer;"><i class="fa-solid fa-trash"></i></button></div>`;
            });
        }
        async function addNewBrowser() {
            const n = document.getElementById('newBrowserName').value.trim();
            const p = document.getElementById('newBrowserPath').value.replace(/"/g, '').trim();
            if (!n || !p) return alert("Please enter Name and Path");
            appData.browsers.push({ name:n, path:p });
            await eel.save_data(appData)(); renderBrowserManagerList(); populateBrowserDropdown();
        }
        async function removeBrowser(i) {
            if(confirm("Remove?")) { appData.browsers.splice(i, 1); await eel.save_data(appData)(); renderBrowserManagerList(); populateBrowserDropdown(); }
        }
        function populateBrowserDropdown() {
            const s = document.getElementById('b_browserSelect'); const cv = s.value; s.innerHTML = '';
            appData.browsers.forEach(b => { const o = document.createElement('option'); o.value = b.name; o.innerText = b.name; s.appendChild(o); });
            if(cv && Array.from(s.options).some(o=>o.value===cv)) s.value = cv;
        }

        // --- BROWSER EDITOR ---
        function openBrowserEditor(mode, name=null) {
            const modal = document.getElementById('browserEditor');
            b_urls = []; b_startupApps = []; // Reset lists
            editingGroupName = null;
            document.getElementById('b_groupName').value = ''; 
            document.getElementById('b_urlList').innerHTML = '';
            document.getElementById('b_startupAppList').innerHTML = ''; // Clear app list
            
            populateBrowserDropdown();
            document.querySelectorAll('input[name="b_iconType"]')[0].checked = true; toggleBIconInput();

            if(mode === 'edit' && name) {
                editingGroupName = name; document.getElementById('b_groupName').value = name;
                const data = browserGroups[name]; 
                
                b_urls = data.urls || []; renderUrlList();
                b_startupApps = data.startupApps || []; renderStartupAppList(); // Load apps

                const exists = appData.browsers.find(b => b.name === data.browser);
                if(exists) document.getElementById('b_browserSelect').value = data.browser;
                
                handleBrowserSelect(); 
                
                setTimeout(() => { document.getElementById('b_profileSelect').value = data.profile_folder; }, 300);

                const radios = document.getElementsByName('b_iconType'); for(let r of radios) { if(r.value === data.iconType) r.checked = true; }
                toggleBIconInput(); if(data.iconType === 'font') document.getElementById('b_appIconInput').value = data.icon;
            } else { handleBrowserSelect(); }
            modal.style.display = 'flex';
        }

        function handleBrowserSelect() {
            const name = document.getElementById('b_browserSelect').value;
            const bData = appData.browsers.find(b => b.name === name);
            const pDiv = document.getElementById('b_profileDiv');
            
            if (bData && bData.path) {
                const pathLower = bData.path.toLowerCase();
                if (pathLower.includes("chrome.exe") || pathLower.includes("msedge.exe") || pathLower.includes("brave.exe")) {
                    pDiv.style.display = 'block';
                    loadProfiles(bData.path); 
                } else {
                    pDiv.style.display = 'none';
                }
            } else { pDiv.style.display = 'none'; }
        }

        async function loadProfiles(path) { 
            const s = document.getElementById('b_profileSelect'); s.innerHTML='<option>Loading...</option>'; 
            const p = await eel.get_profiles_from_path(path)(); 
            s.innerHTML = ''; 
            if(Object.keys(p).length===0) s.innerHTML='<option value="Default">Default</option>'; 
            else for(const [n,v] of Object.entries(p)) s.innerHTML+=`<option value="${v}">${n}</option>`; 
        }

        // --- NEW: STARTUP APPS LOGIC ---
        function addStartupAppItem() {
            const i = document.getElementById('b_startupAppInput');
            const val = i.value.replace(/"/g, '').trim();
            if(val) { b_startupApps.push(val); i.value=''; renderStartupAppList(); }
        }
        function renderStartupAppList() {
            const u = document.getElementById('b_startupAppList'); u.innerHTML = '';
            b_startupApps.forEach((app, i) => {
                u.innerHTML += `<li style="display:flex;justify-content:space-between;border-bottom:1px solid #444;padding:5px;font-size:0.85rem;"><span style="word-break:break-all;">${app}</span><span onclick="b_startupApps.splice(${i},1);renderStartupAppList()" style="cursor:pointer;color:#e74c3c;"><i class="fa-solid fa-xmark"></i></span></li>`;
            });
        }

        async function saveBrowserGroup() {
            const name = document.getElementById('b_groupName').value; if(!name) return alert("Name required");
            const bName = document.getElementById('b_browserSelect').value;
            const profile = document.getElementById('b_profileSelect').value;
            
            const bData = appData.browsers.find(b => b.name === bName);
            if(!bData) return alert("Browser invalid");
            
            const iconType = document.querySelector('input[name="b_iconType"]:checked').value;
            let iconValue = document.getElementById('b_appIconInput').value.trim();
            let iconData = null;

            if (iconType === 'image') {
                const f = document.getElementById('b_appImgFile').files[0];
                if (f) iconData = await toBase64(f);
                else if (editingGroupName && browserGroups[editingGroupName]) iconData = browserGroups[editingGroupName].iconData;
            } else if (iconType === 'default') {
                if(bData.path) iconData = await eel.extract_exe_icon(bData.path)();
                if(!iconData && editingGroupName && browserGroups[editingGroupName]) iconData = browserGroups[editingGroupName].iconData;
            } else if (editingGroupName && browserGroups[editingGroupName]) {
                iconData = browserGroups[editingGroupName].iconData;
            }

            // Save Startup Apps
            const data = { 
                browser: bName, 
                exePath: bData.path, 
                profile_folder: profile, 
                urls: b_urls, 
                startupApps: b_startupApps, // Include new list
                iconType, 
                icon: iconValue, 
                iconData 
            };
            
            if(editingGroupName && editingGroupName !== name) await eel.delete_group(editingGroupName)();
            await eel.save_group(name, data)();
            browserGroups = await eel.get_saved_groups()(); renderBrowserCards(); document.getElementById('browserEditor').style.display='none';
        }

        // --- BACKGROUND SETTINGS ---
        function openSettings() { document.getElementById('settingsModal').style.display='flex'; document.getElementById('bgPreviewStatus').innerText="No file selected"; tempBgData=null; }
        function closeSettings() { document.getElementById('settingsModal').style.display='none'; }
        
        async function selectBgFromPython(type) {
            const resultPath = await eel.select_and_copy_bg(type)();
            if (resultPath) {
                document.getElementById('bgPreviewStatus').innerText = "Selected: " + resultPath;
                tempBgData = { url: resultPath, type: type };
            }
        }

        async function saveSettings() {
            if(!tempBgData) { closeSettings(); return; }
            const isAll = document.getElementById('bgApplyAll').checked;
            if(isAll) {
                appData.globalBg = tempBgData.url; appData.globalBgType = tempBgData.type;
                appData.tags.forEach(t => { t.bg = ""; t.bgType = ""; });
            } else {
                const tag = appData.tags.find(t => t.id === currentTagId);
                if(tag) { tag.bg = tempBgData.url; tag.bgType = tempBgData.type; }
            }
            await eel.save_data(appData)();
            applyBackground(tempBgData.url, tempBgData.type);
            closeSettings();
        }

        // --- COMMON LOGIC ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        
        // Update Sidebar to show Dev Mode indicator
        function renderSidebar() { 
            const l=document.getElementById('tagList'); l.innerHTML=''; 
            appData.tags.forEach(t=>{ 
                const d=document.createElement('div'); 
                d.className=`nav-item ${currentTagId===t.id?'active':''}`; 
                const e=t.type!=='system'?`<i class="fa-solid fa-pen edit-tag-btn" onclick="openTagModal('edit','${t.id}')"></i>`:''; 
                
                // Dev Mode Icon
                const devIcon = t.devMode ? `<i class="fa-solid fa-code" title="Dev Mode" style="font-size:0.7rem; color:#f39c12; margin-left:5px;"></i>` : '';

                d.innerHTML=`<div class="nav-content" onclick="switchTab('${t.id}')"><i class="fa-solid ${t.icon}"></i><span class="nav-text">${t.name} ${devIcon}</span></div>${e}`; 
                l.appendChild(d); 
            }); 
        }
        
        function switchTab(id) { 
            currentTagId=id; renderSidebar(); 
            const c=document.getElementById('viewsContainer'); c.innerHTML=''; 
            const t=appData.tags.find(x=>x.id===id); if(!t)return; 
            const bg = t.bg || appData.globalBg; const type = t.bgType || appData.globalBgType;
            applyBackground(bg, type);
            if(id==='browser') renderBrowserView(c); else renderAppView(c,t); 
        }
        
        function applyBackground(url, type) {
            const v = document.getElementById('bgVideo');
            if (!url) { v.pause(); v.style.display='none'; document.body.style.backgroundImage='none'; document.body.style.backgroundColor='#1a1a1a'; return; }
            if(type === 'video') { v.src = url; v.style.display='block'; v.play(); document.body.style.backgroundImage='none'; }
            else { v.pause(); v.style.display='none'; document.body.style.backgroundImage=`url('${url}')`; document.body.style.backgroundSize='cover'; }
        }

        function renderBrowserView(c) { c.innerHTML=`<div class="glass-container view-section active"><div class="dashboard-header"><div class="title">App Management</div><div class="search-box"><i class="fa-solid fa-search"></i><input type="text" placeholder="Search..." onkeyup="filterApps(this)"></div><button class="btn-bg" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button></div><div id="browserDashboard" class="app-grid"></div></div>`; renderBrowserCards(); }
        
        // Update Browser Launch Call to include startupApps
        function renderBrowserCards() { 
            const g=document.getElementById('browserDashboard'); g.innerHTML=''; 
            for(const [n,d] of Object.entries(browserGroups)){ 
                const c=document.createElement('div'); c.className='app-card'; 
                let ih=''; 
                if(d.iconType==='image'&&d.iconData)ih=`<img src="${d.iconData}" class="app-icon-img">`; 
                else if(d.iconType==='font')ih=`<i class="${d.icon||'fa-solid fa-folder-open'} app-icon-font"></i>`; 
                else if(d.iconType==='default'&&d.iconData)ih=`<img src="${d.iconData}" class="app-icon-img">`; 
                else ih=`<i class="fa-solid fa-globe app-icon-font" style="color:#4facfe;"></i>`; 
                
                c.innerHTML=`<div class="card-actions"><button class="action-btn btn-edit" onclick="openBrowserEditor('edit','${n}')"><i class="fa-solid fa-pen"></i></button><button class="action-btn btn-delete" onclick="deleteGroup('${n}')"><i class="fa-solid fa-trash"></i></button></div>${ih}<span>${n}</span>`; 
                
                // Pass startupApps to python
                c.onclick=e=>{if(e.target.closest('.card-actions'))return; eel.launch_group_urls(d.exePath, d.profile_folder, d.urls, d.startupApps || []);}; 
                g.appendChild(c); 
            } 
        }

        function renderAppView(c,t) { c.innerHTML=`<div class="glass-container view-section active"><div class="dashboard-header"><div class="title">${t.name}</div><div class="search-box"><i class="fa-solid fa-search"></i><input type="text" placeholder="Search..." onkeyup="filterApps(this)"></div><button class="btn-bg" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button></div><div class="app-grid" id="grid-${t.id}"></div></div>`; const g=document.getElementById(`grid-${t.id}`); const a=appData.apps[t.id]||[]; if(a.length===0)g.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:50px;">Empty</div>'; a.forEach((ap,i)=>{ const cd=document.createElement('div'); cd.className='app-card'; let ih=`<i class="fa-solid fa-cube app-icon-font"></i>`; if(ap.iconType==='image'&&ap.iconData)ih=`<img src="${ap.iconData}" class="app-icon-img">`; else if(ap.iconType==='font')ih=`<i class="${ap.icon||'fa-solid fa-cube'} app-icon-font"></i>`; else if(ap.iconType==='default'&&ap.iconData)ih=`<img src="${ap.iconData}" class="app-icon-img">`; cd.innerHTML=`<div class="card-actions"><button class="action-btn btn-edit" onclick="openAppModal('edit','${t.id}',${i})"><i class="fa-solid fa-pen"></i></button><button class="action-btn btn-delete" onclick="deleteApp('${t.id}',${i})"><i class="fa-solid fa-trash"></i></button></div>${ih}<span>${ap.name}</span>`; cd.onclick=e=>{if(e.target.closest('.card-actions'))return; eel.launch_app(ap.path);}; g.appendChild(cd); }); }
        
        function filterApps(i) { const q=i.value.toLowerCase(); const c=i.closest('.glass-container').querySelector('.app-grid'); if(!c)return; Array.from(c.getElementsByClassName('app-card')).forEach(cd=>{ const n=cd.querySelector('span').innerText.toLowerCase(); cd.style.display=n.includes(q)?'flex':'none'; }); }
        
        function addUrlItem() { const i=document.getElementById('b_urlInput'); if(i.value){b_urls.push(i.value);i.value='';renderUrlList();} }
        function renderUrlList() { const u=document.getElementById('b_urlList'); u.innerHTML=''; b_urls.forEach((l,i)=>u.innerHTML+=`<li style="display:flex;justify-content:space-between;border-bottom:1px solid #444;padding:5px;"><span>${l}</span><span onclick="b_urls.splice(${i},1);renderUrlList()" style="cursor:pointer;color:red;">x</span></li>`); }
        function toggleBIconInput() { const t=document.querySelector('input[name="b_iconType"]:checked').value; document.getElementById('b_iconFontGroup').style.display=t==='font'?'block':'none'; document.getElementById('b_iconImageGroup').style.display=t==='image'?'block':'none'; }
        async function deleteGroup(n) { if(confirm("Delete?")){await eel.delete_group(n)(); browserGroups=await eel.get_saved_groups()(); renderBrowserCards();} }
        function toggleIconInput() { const t=document.querySelector('input[name="iconType"]:checked').value; document.getElementById('iconFontGroup').style.display=t==='font'?'block':'none'; document.getElementById('iconImageGroup').style.display=t==='image'?'block':'none'; }
        function openAppModal(m,id,ix=null) { const mo=document.getElementById('appModal'); document.getElementById('appNameInput').value=''; document.getElementById('appPathInput').value=''; document.getElementById('editAppIndex').value=''; document.querySelectorAll('input[name="iconType"]')[0].checked=true; toggleIconInput(); if(m==='edit'){document.getElementById('appModalTitle').innerText="Edit App"; document.getElementById('editAppIndex').value=ix; const a=appData.apps[id][ix]; document.getElementById('appNameInput').value=a.name; document.getElementById('appPathInput').value=a.path; const rs=document.getElementsByName('iconType'); for(let r of rs){if(r.value===a.iconType)r.checked=true;} toggleIconInput(); if(a.iconType==='font')document.getElementById('appIconInput').value=a.icon;} else document.getElementById('appModalTitle').innerText="Add App"; mo.style.display='flex'; }
        async function saveAppItem() { const n=document.getElementById('appNameInput').value.trim(); const p=document.getElementById('appPathInput').value.replace(/"/g,'').trim(); const ei=document.getElementById('editAppIndex').value; const it=document.querySelector('input[name="iconType"]:checked').value; let iv=document.getElementById('appIconInput').value.trim(); let id=null; if(it==='image'){const f=document.getElementById('appImgFile').files[0]; if(f)id=await toBase64(f); else if(ei!=="")id=appData.apps[currentTagId][ei].iconData;} else if(it==='default'){id=await eel.extract_exe_icon(p)(); if(!id&&ei!=="")id=appData.apps[currentTagId][ei].iconData;} const na={name:n,path:p,iconType:it,icon:iv,iconData:id}; if(!appData.apps[currentTagId])appData.apps[currentTagId]=[]; if(ei!=="")appData.apps[currentTagId][ei]=na; else appData.apps[currentTagId].push(na); document.getElementById('appModal').style.display='none'; await eel.save_data(appData)(); if(currentTagId!=='browser')renderAppView(document.getElementById('viewsContainer'),appData.tags.find(t=>t.id===currentTagId)); }
        async function deleteApp(t,i) { if(confirm("Delete?")){appData.apps[t].splice(i,1); await eel.save_data(appData)(); renderAppView(document.getElementById('viewsContainer'),appData.tags.find(x=>x.id===t));} }
        function handleFabClick() { if(currentTagId==='browser')openBrowserEditor('create'); else openAppModal('create'); }
        const toBase64=f=>new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result);d.onerror=j;});
        
        // --- TAG MANAGEMENT (Updated for Dev Mode) ---
// --- TAG MANAGEMENT (Updated) ---
        function openTagModal(m, id) { 
            const mo = document.getElementById('tagModal'); 
            document.getElementById('tagNameInput').value = ''; 
            document.getElementById('tagIdEdit').value = ''; 
            document.getElementById('tagDevModeInput').checked = false;
            
            // ซ่อนปุ่ม Delete ไว้ก่อนเป็นค่าเริ่มต้น
            const delBtn = document.getElementById('btnDeleteTag');
            delBtn.style.display = 'none';

            if (m === 'edit') {
                const t = appData.tags.find(x => x.id === id); 
                document.getElementById('tagNameInput').value = t.name; 
                document.getElementById('tagIconInput').value = t.icon; 
                document.getElementById('tagIdEdit').value = t.id;
                document.getElementById('tagDevModeInput').checked = t.devMode || false;

                // เช็คว่าไม่ใช่ System Tag (เช่น Browser/App Management) ถึงจะโชว์ปุ่มลบ
                if (t.type !== 'system' && t.id !== 'browser') {
                    delBtn.style.display = 'block';
                }
            } 
            mo.style.display = 'flex'; 
        }

        // เพิ่มฟังก์ชันสำหรับลบ Tag
        async function deleteTag() {
            const id = document.getElementById('tagIdEdit').value;
            if (!id) return;

            if (confirm("Are you sure you want to delete this Tag and all its apps?")) {
                // 1. ลบ Tag ออกจากอาร์เรย์
                const index = appData.tags.findIndex(x => x.id === id);
                if (index > -1) {
                    appData.tags.splice(index, 1);
                }

                // 2. ลบข้อมูล Apps ที่อยู่ใน Tag นั้น
                if (appData.apps[id]) {
                    delete appData.apps[id];
                }

                // 3. ปิดหน้าต่างและบันทึก
                document.getElementById('tagModal').style.display = 'none';
                await eel.save_data(appData)();

                // 4. สลับกลับไปหน้าแรกและรีเฟรช Sidebar
                if (appData.tags.length > 0) {
                    switchTab(appData.tags[0].id);
                }
                renderSidebar();
            }
        }
        
        async function saveTag() { 
            const id=document.getElementById('tagIdEdit').value; 
            const n=document.getElementById('tagNameInput').value; 
            const i=document.getElementById('tagIconInput').value||'fa-folder'; 
            const isDev = document.getElementById('tagDevModeInput').checked; // Get state

            if(id){
                const t=appData.tags.find(x=>x.id===id);
                t.name=n;
                t.icon=i;
                t.devMode=isDev; // Save state
            }else{
                const nid='tag_'+Date.now(); 
                appData.tags.push({id:nid,name:n,icon:i,type:'custom',bg:'',bgType:'', devMode:isDev}); 
                appData.apps[nid]=[];
            } 
            document.getElementById('tagModal').style.display='none'; 
            await eel.save_data(appData)(); 
            renderSidebar(); 
        }
        
        window.onclick=e=>{if(e.target.className==='editor-overlay')e.target.style.display='none';}

        async function pickExePath(inputId) {
            const path = await eel.browse_exe_path()();
            if (path) { document.getElementById(inputId).value = path; }
        }
    </script>
</body>
</html>